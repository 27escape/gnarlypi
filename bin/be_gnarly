#!/usr/bin/env bash
# ----------------------------------------------------------------------------

# for your user, create an entry in your crontab
# @reboot /home/$USER/gnarlypi/be_gnarly

# ----------------------------------------------------------------------------

source "$HOME/gnarlypi/setenv.sh"

cd "$BIN_PATH" || (echo "cannot find dir $BIN_PATH" && exit 1)

SELF=$(basename "$0")
processes_to_kill=$(ps ax | grep "gnarly" | grep -v grep | grep -v "$SELF")

# bash 4 and later map text into array
mapfile -t lines <<< "$processes_to_kill"

for line in "${lines[@]}"; do
  # Process the line here
  pid=$(echo "$line" | awk '{print $1}')
  kill $pid 2>/dev/null
done

# remove any previous log files
rm -f /tmp/gnarlypi* 2>/dev/null

# this will start up other apps as required, inc the status displays
"./gnarlypi"  >> $GNARLY_ERR_LOG 2>&1
